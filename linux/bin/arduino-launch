#!/bin/sh -x

# resolving this script path
BIN_ABSPATH=$(cd "$(dirname "$0")"; pwd)

# resolving messages folder path
PROCESSES_ABSPATH=$BIN_ABSPATH/../processes

# Retrieve handle and remove it from the params
HANDLE=$1
shift

# Making folder for this process outputs and 
BASEDIR=$PROCESSES_ABSPATH/$HANDLE
rm -rf $BASEDIR
mkdir $BASEDIR

OUT_FILE=$BASEDIR/stdout
ERR_FILE=$BASEDIR/stderr
IN_FILE=$BASEDIR/stdin
PID_FILE=$BASEDIR/running
EXITCODE_FILE=$BASEDIR/exit_code

$* > $OUT_FILE 2> $ERR_FILE &
PID=$!

# Save the process number
echo $PID > $PID_FILE

# Wait for process termination
wait $PID

# Save the exit code
echo $? > $EXITCODE_FILE
rm -f $PID_FILE
